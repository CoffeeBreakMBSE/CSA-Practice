<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSA Practice</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 860px; margin: 24px auto; padding: 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    button { padding: 10px 14px; border: 1px solid #ccc; background: #fafafa; border-radius: 10px; cursor: pointer; }
    button.primary { background: #1f6feb; color: white; border-color: #1f6feb; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .pill { font-size: 12px; padding: 4px 10px; border-radius: 999px; background: #f2f2f2; }
    .opt { display: block; padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; margin: 8px 0; cursor: pointer; }
    .opt input { margin-right: 8px; }
    .good { color: #1a7f37; }
    .bad { color: #cf222e; }
    .muted { color: #666; }
    select, input[type="file"] { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; }
    .hint { font-size: 12px; color: #666; margin-top: 8px; line-height: 1.35; }
    code { background: #f6f8fa; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>ServiceNow CSA Practice</h1>

  <div class="card">
    <div class="row" style="justify-content: space-between;">
      <div class="row">
        <span class="pill" id="stats">0/0</span>
        <span class="pill" id="score">Score: 0</span>

        <label class="muted">Module:
          <select id="moduleFilter">
            <option value="ALL">All</option>
          </select>
        </label>
      </div>

      <div class="row">
        <!-- Works even if you open index.html directly -->
        <input type="file" id="fileInput" accept=".csv" />
      </div>
    </div>

    <div class="row">
      <button id="btnPrev">Prev</button>
      <button class="primary" id="btnNext">Next</button>
      <button id="btnShuffle">Shuffle</button>
      <button id="btnReset">Reset</button>
    </div>

    <div class="hint">
      <strong>CSV format required:</strong>
      <code>id,module,question,A,B,C,D,answer,explanation</code> where <code>answer</code> is A/B/C/D.<br/>
      If you want auto-load, put <code>questions.csv</code> in the same folder as <code>index.html</code>
      and serve with a local server (example: <code>python -m http.server 8000</code>).
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content: space-between;">
      <div><div class="pill" id="modulePill">Module</div></div>
      <div class="muted" id="qIndex">Question</div>
    </div>

    <h2 id="questionText" style="margin: 12px 0 8px;"></h2>
    <div id="options"></div>

    <div id="feedback" style="margin-top: 12px;"></div>
  </div>

  <script>
    /**
     * CSV expected headers (case-insensitive):
     * id,module,question,A,B,C,D,answer,explanation
     * - answer must be A/B/C/D
     */

    // --- Default fallback questions if no CSV is loaded ---
    let QUESTIONS = [
      {
        id: "M2-Q01",
        module: "Module 2: User Administration",
        text: "Which record defines what a user can do in ServiceNow?",
        options: ["Group", "Role", "Department", "Location"],
        correctIndex: 1,
        explanation: "Roles grant permissions; groups are mainly for assignment and role inheritance."
      },
      {
        id: "M3-Q01",
        module: "Module 3: Configure Applications for Business",
        text: "What does a list view control?",
        options: ["Which records are returned", "Which fields are shown and their order", "Field-level security", "Business logic"],
        correctIndex: 1,
        explanation: "Filters control which records you see; views control which columns appear."
      },
      {
        id: "M8-Q01",
        module: "Module 8: Update Sets",
        text: "What is the correct order when importing an update set?",
        options: ["Commit → Preview → Retrieve", "Retrieve → Commit → Preview", "Retrieve → Preview → Commit", "Preview → Retrieve → Commit"],
        correctIndex: 2,
        explanation: "You retrieve/import, preview to identify issues, then commit to apply changes."
      }
    ];

    // --- App state ---
    let filtered = [];
    let idx = 0;
    let score = 0;
    const answers = new Map(); // index-in-filtered -> chosenIndex

    // --- Elements ---
    const moduleFilter = document.getElementById("moduleFilter");
    const modulePill = document.getElementById("modulePill");
    const qIndex = document.getElementById("qIndex");
    const questionText = document.getElementById("questionText");
    const optionsEl = document.getElementById("options");
    const feedbackEl = document.getElementById("feedback");
    const statsEl = document.getElementById("stats");
    const scoreEl = document.getElementById("score");
    const fileInput = document.getElementById("fileInput");

    document.getElementById("btnPrev").onclick = () => { if (idx > 0) { idx--; render(); } };
    document.getElementById("btnNext").onclick = () => { if (idx < filtered.length - 1) { idx++; render(); } };
    document.getElementById("btnShuffle").onclick = () => { shuffle(filtered); idx = 0; answers.clear(); score = 0; render(); };
    document.getElementById("btnReset").onclick = () => { idx = 0; answers.clear(); score = 0; render(); };

    moduleFilter.onchange = () => applyFilter(moduleFilter.value);

    // Upload CSV (works without server)
    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const text = await file.text();
      const parsed = parseCSVToQuestions(text);

      if (parsed.length === 0) {
        alert("No valid questions found in CSV. Please check headers and data.");
        return;
      }

      QUESTIONS = parsed;
      resetAndInit();
    });

    // Try auto-load questions.csv (requires local server)
    // If it fails, app still runs with fallback QUESTIONS above.
    (async function tryAutoLoadCSV() {
      try {
        const res = await fetch("./questions.csv", { cache: "no-store" });
        if (!res.ok) throw new Error("questions.csv not found");
        const csv = await res.text();
        const parsed = parseCSVToQuestions(csv);
        if (parsed.length > 0) QUESTIONS = parsed;
      } catch (err) {
        // Silent fallback
      } finally {
        resetAndInit();
      }
    })();

    function resetAndInit() {
      idx = 0;
      score = 0;
      answers.clear();
      buildModuleDropdown();
      applyFilter("ALL");
    }

    function buildModuleDropdown() {
      // Rebuild module dropdown
      moduleFilter.innerHTML = `<option value="ALL">All</option>`;
      const modules = Array.from(new Set(QUESTIONS.map(q => q.module))).filter(Boolean).sort();
      for (const m of modules) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        moduleFilter.appendChild(opt);
      }
    }

    function applyFilter(moduleName) {
      filtered = moduleName === "ALL" ? [...QUESTIONS] : QUESTIONS.filter(q => q.module === moduleName);
      idx = 0;
      score = 0;
      answers.clear();
      render();
    }

    function render() {
      if (filtered.length === 0) {
        questionText.textContent = "No questions available. Load a CSV or choose another module.";
        optionsEl.innerHTML = "";
        feedbackEl.innerHTML = "";
        modulePill.textContent = "—";
        qIndex.textContent = "";
        statsEl.textContent = "0/0";
        scoreEl.textContent = "Score: 0";
        return;
      }

      const q = filtered[idx];
      modulePill.textContent = q.module || "—";
      qIndex.textContent = `Q ${idx + 1} of ${filtered.length}` + (q.id ? `  •  ${q.id}` : "");
      questionText.textContent = q.text;

      statsEl.textContent = `${answers.size}/${filtered.length}`;
      scoreEl.textContent = `Score: ${score}`;

      optionsEl.innerHTML = "";
      feedbackEl.innerHTML = "";

      const chosen = answers.get(idx);

      q.options.forEach((optText, i) => {
        const label = document.createElement("label");
        label.className = "opt";

        const input = document.createElement("input");
        input.type = "radio";
        input.name = "opt";
        input.checked = chosen === i;
        input.onchange = () => selectAnswer(i);

        label.appendChild(input);
        label.appendChild(document.createTextNode(`${String.fromCharCode(65 + i)}. ${optText}`));
        optionsEl.appendChild(label);
      });

      if (chosen !== undefined) showFeedback(q, chosen);
    }

    function selectAnswer(choice) {
      const q = filtered[idx];
      const prev = answers.get(idx);

      // Adjust score if re-answering
      if (prev !== undefined) {
        const wasCorrect = prev === q.correctIndex;
        const nowCorrect = choice === q.correctIndex;
        if (wasCorrect && !nowCorrect) score--;
        if (!wasCorrect && nowCorrect) score++;
      } else {
        if (choice === q.correctIndex) score++;
      }

      answers.set(idx, choice);
      showFeedback(q, choice);

      statsEl.textContent = `${answers.size}/${filtered.length}`;
      scoreEl.textContent = `Score: ${score}`;
    }

    function showFeedback(q, choice) {
      const correct = q.correctIndex;
      const ok = choice === correct;

      feedbackEl.innerHTML = `
        <div class="${ok ? "good" : "bad"}" style="font-weight: 700;">
          ${ok ? "Correct ✅" : `Incorrect ❌ (Correct: ${String.fromCharCode(65 + correct)})`}
        </div>
        <div class="muted" style="margin-top: 6px;">
          ${escapeHTML(q.explanation || "")}
        </div>
      `;
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // --- CSV Parsing ---

    function parseCSVToQuestions(csvText) {
      const lines = csvText.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n").filter(l => l.trim().length > 0);
      if (lines.length < 2) return [];

      const headers = splitCSVLine(lines[0]).map(h => h.trim().toLowerCase());
      const idxOf = (name) => headers.indexOf(name.toLowerCase());

      const required = ["module", "question", "a", "b", "c", "d", "answer"];
      for (const r of required) {
        if (idxOf(r) === -1) {
          console.warn("Missing required CSV header:", r);
          return [];
        }
      }

      const idI = idxOf("id");
      const moduleI = idxOf("module");
      const qI = idxOf("question");
      const aI = idxOf("a");
      const bI = idxOf("b");
      const cI = idxOf("c");
      const dI = idxOf("d");
      const ansI = idxOf("answer");
      const expI = idxOf("explanation");

      const out = [];

      for (let r = 1; r < lines.length; r++) {
        const cols = splitCSVLine(lines[r]);
        const module = (cols[moduleI] || "").trim();
        const text = (cols[qI] || "").trim();
        const A = (cols[aI] || "").trim();
        const B = (cols[bI] || "").trim();
        const C = (cols[cI] || "").trim();
        const D = (cols[dI] || "").trim();
        const answer = (cols[ansI] || "").trim().toUpperCase();
        const explanation = expI >= 0 ? (cols[expI] || "").trim() : "";
        const id = idI >= 0 ? (cols[idI] || "").trim() : "";

        if (!module || !text || !A || !B || !C || !D) continue;

        const correctIndex = "ABCD".indexOf(answer);
        if (correctIndex === -1) continue;

        out.push({
          id,
          module,
          text,
          options: [A, B, C, D],
          correctIndex,
          explanation
        });
      }

      return out;
    }

    // Handles commas inside quotes and double-quotes escaping
    function splitCSVLine(line) {
      const result = [];
      let current = "";
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];

        if (ch === '"') {
          // handle escaped quote ""
          const next = line[i + 1];
          if (inQuotes && next === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === "," && !inQuotes) {
          result.push(current);
          current = "";
        } else {
          current += ch;
        }
      }
      result.push(current);
      return result;
    }

    function escapeHTML(str) {
      return str
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
